# 输入容错与 Sheet 识别规则

> 目标：**输入端容错、识别动态 Sheet**；**输出端固定模板 1:1**。

## 1. 总体原则
- **输入容错**：允许多余/新增月份 sheet（如“2026年1月…”），允许列名轻微差异、空列、重复列。
- **输出固定**：输出始终为定稿模板 11 个 sheet，格式/合并/公式完全一致。
- **未知 sheet**：识别失败时**不参与计算**，但保留原始信息用于问题提示与溯源。

## 2. Sheet 识别策略（多层容错）

### 2.1 识别方式
- **结构相似度识别**（主策略）：
  - 从列名集合中匹配“关键字段集合”，计算相似度（命中率 = 命中字段数 / 关键字段数）。
  - 命中率 ≥ 0.7 视为匹配成功；0.5~0.7 视为“疑似”，进入人工确认；<0.5 视为未知。
- **次级规则**：
  - 若 sheet 名包含“批发/零售/住宿/餐饮/批零/住餐/小微/吃穿用/汇总/社零额”等关键词，可提高 0.1~0.2 权重。
  - 若列名存在“本年-本月/上年-本月/本年-1—本月”等口径字段，优先判定为业务数据表。

### 2.2 关键字段集合（用于识别）

#### A. 批零主表（批发/零售）识别字段（命中 ≥ 8/11）
- 统一社会信用代码
- 单位详细名称
- [201-1] 行业代码(GB/T4754-2017)
- 2025年12月销售额
- 2024年;12月;商品销售额;千元
- 2025年1-12月销售额
- 2024年;1-12月;商品销售额;千元
- 2025年12月零售额
- 2024年;12月;商品零售额;千元
- 2025年1-12月零售额
- 2024年;1-12月;商品零售额;千元

> 容错：年份和月份可能变化，可通过正则提取“YYYY年MM月销售额/零售额”匹配

#### B. 住餐主表（住宿/餐饮）识别字段（命中 ≥ 8/12）
- 统一社会信用代码
- 单位详细名称
- [201-1] 行业代码(GB/T4754-2017)
- 2025年12月营业额
- 2024年12月;营业额总计;千元
- 2025年1-12月营业额
- 2024年1-12月;营业额总计;千元
- 2025年12月客房收入
- 2024年12月;营业额总计;客房收入;千元
- 2025年12月餐费收入
- 2024年12月;营业额总计;餐费收入;千元
- 2025年12月销售额

#### C. 批零历史快照表（批零类月度表）识别字段（命中 ≥ 6/8）
- 统一社会信用代码
- 单位详细名称
- 201-1-行业代码（GB/T4754-2017）
- 商品销售额;本年-本月
- 商品销售额;本年-1—本月
- 零售额;本年-本月
- 零售额;本年-1—本月
- 201-1-单位规模

#### D. 住餐历史快照表识别字段（命中 ≥ 6/8）
- 统一社会信用代码
- 单位详细名称
- 201-1-行业代码（GB/T4754-2017）
- 营业额;本年-本月
- 营业额;本年-1—本月
- 客房收入;本年-本月
- 餐费收入;本年-本月
- 商品销售额;本年-本月

#### E. 吃穿用 sheet（命中 ≥ 10/14）
- 处理地编码
- 统一社会信用代码
- 单位详细名称
- 201-1-行业代码（GB/T4754-2017）
- 商品销售额;本年-本月
- 商品销售额;上年-本月
- (衍生指标)当月销售额增速
- 零售额;本年-本月
- 零售额;上年-本月
- (衍生指标)当月零售额增速
- (衍生指标)当月吃穿用零售额
- (衍生指标)上年同月吃穿用零售额
- 201-1-单位规模
- 其中：通过公共网络实现的商品销售额;本年-本月

#### F. 小微 sheet（命中 ≥ 4/6）
- 处理地编码
- 统一社会信用代码
- 单位详细名称
- (衍生指标)计算用小微当月零售额
- (衍生指标)计算用小微上年同月零售额
- (衍生指标)小微当月零售额增速

#### G. 吃穿用（剔除）sheet（命中 ≥ 3/5）
- 处理地编码
- 统一社会信用代码
- 单位详细名称
- (衍生指标)吃穿用当月零售额
- (衍生指标)吃穿用上年同月零售额

#### H. 汇总/社零额模板
- 社零额（定）：存在大量公式、合并单元格
- 汇总表（定）：固定标题与 4 个公式

---

## 3. Sheet 角色冲突与优先级
若多个 sheet 同时匹配同一类型：
1) 优先选择“字段命中率最高”的 sheet
2) 若命中率相同，优先选择“最新月份”（从字段或 sheet 名解析年月）
3) 若仍冲突，进入 UI 提示人工确认

---

## 4. 动态月份识别（容错）
- 针对列名形如 `2025年12月销售额`、`2024年;12月;商品销售额;千元`：
  - 用正则提取“年份/月份”
  - 记录为 meta：currentYear/currentMonth/lastYear
- 若缺失年份信息，退化为“本年/上年”口径解析

---

## 5. 页面解析容错（UI）
- **识别结果展示**：列出每个 sheet 的“类型、命中率、关键字段缺失”
- **人工确认入口**：疑似 sheet 可手工指定类型
- **错误分级**：
  - Error：缺失核心字段（如“本年-本月/上年-本月”）
  - Warn：字段存在但为空值比例过高
- **不阻断导入**：允许带 Warn 导入，但提示结果可能偏差

---

## 6. 输出固定格式
- 无论输入存在多少额外 sheet，输出始终为：
  - 批零总表 / 住餐总表 / 批发 / 零售 / 住宿 / 餐饮 / 吃穿用 / 小微 / 吃穿用（剔除） / 社零额（定） / 汇总表（定）
- 任何未知 sheet **不输出**，但在“导入报告”中记录。

