# 识别规则：算法伪代码与正则

> 本文是 `prd/06_输入容错与Sheet识别规则.md` 的“可落地实现版”，用于指导后端识别模块与前端人工确认交互。

## 1. 目标与输出

输入：一个 Excel 工作簿（任意 sheet 数量、sheet 名/列名存在轻微差异）。

输出：
- 每个 sheet 的识别结果：`type / score / missingFields`
- 可选“操作月份”列表：从 sheet 名/列名提取到的月份（1-12）

## 2. 字段标准化规则（Header Normalization）

**目的：**让“同义/格式差异”的列名映射到统一 token，提升命中率稳定性。

规则（按顺序执行）：
1) `TrimSpace`：去掉首尾空格，合并连续空白为单个空格
2) 全角转半角：`；`→`;`，`（`→`(`，`）`→`)`，`—/–`→`-`
3) 统一分隔符：把 `｜`、`/`、`、` 等替换为 `;`（仅用于识别，不改变原始值）
4) 统一括号内容：
   - `行业代码(GB/T4754-2017)`、`行业代码（GB/T4754-2017）` → `行业代码(GB/T4754-2017)`
5) 年月占位（用于“关键字段匹配”）：
   - `2025年12月销售额`、`2024年;12月;商品销售额;千元` 中的 `YYYY年MM月` 作为 `YEAR_MONTH` token，仅在识别阶段使用
6) 可选同义词表（建议最小集，避免误伤）：
   - `统一社会信用代码` == `统一社会信用码`（若出现）
   - `单位详细名称` == `单位名称`（若出现）

> 说明：标准化是“识别专用”逻辑，不影响解析/导出；原始 header 仍保留用于 UI 展示与溯源。

## 3. 相似度计算（结构相似度）

### 3.1 关键字段集合
每种 sheet 类型定义一个 `RequiredHeaders`（见 `prd/06_输入容错与Sheet识别规则.md` 的 A~H）。

### 3.2 命中率与得分

给定一个 sheet 的标准化列名集合 `H`，某类型的关键字段集合 `R`：

- `hits = | H ∩ R |`
- `hitRate = hits / |R|`
- `missingFields = R - H`
- `score = hitRate + nameBoost`（并限制到 `[0, 1]`）

`nameBoost`（可选，避免过强）：
- sheet 名含 `批发/零售/住宿/餐饮/批零/住餐/小微/吃穿用/剔除/汇总/社零额` 等关键词时，对对应候选类型加 `0.10 ~ 0.20`

阈值（建议值）：
- `score >= 0.70`：匹配成功（自动判定）
- `0.50 <= score < 0.70`：疑似（进入人工确认）
- `< 0.50`：未知（unknown，不参与计算）

## 4. Sheet 类型判定（冲突处理）

### 4.1 基本流程伪代码
```text
RecognizeWorkbook(workbook):
  results = {}
  months = ExtractMonthsFromWorkbook(workbook)

  for each sheetName in workbook.Sheets:
    headers = ReadHeaderRow(sheetName)
    normHeaders = NormalizeHeaders(headers)

    candidates = []
    for each rule in SheetRules:
      score, missing = Score(rule.RequiredHeaders, normHeaders, sheetName)
      candidates.append({type: rule.Type, score, missing})

    best = pick max(score)
    if best.score < 0.50:
      results[sheetName] = {type: unknown, score: best.score, missingFields: best.missing}
      continue

    ties = all candidates with score == best.score
    if len(ties) > 1:
      best = BreakTieByNameKeyword(ties, sheetName)

    results[sheetName] = best

  return {results, months}
```

### 4.2 冲突优先级
当多个 sheet 匹配同一类型或得分相同：
1) 先选 `score` 更高的
2) 分数相同：优先选择 **能解析出“最新月份”** 的（从 sheet 名或 header 的年月提取）
3) 仍无法区分：进入 UI 提示人工确认

## 5. 月份识别正则（兼容“;12月;”风格）

### 5.1 正则定义
- 年月：`(\\d{4})年(\\d{1,2})月`
- 仅月份（分号风格）：`;\\s*(\\d{1,2})月\\s*;`

### 5.2 月份提取伪代码
```text
ExtractMonths(text):
  months = set()

  for each match of (\\d{4})年(\\d{1,2})月 in text:
    m = toInt(group2)
    if 1<=m<=12: months.add(m)

  for each match of ;\\s*(\\d{1,2})月\\s*; in text:
    m = toInt(group1)
    if 1<=m<=12: months.add(m)

  return sorted(months)
```

来源建议：
- 先从 `sheetName` 提取
- 再从 header 行每个单元格文本提取

## 6. 覆盖的 sheet 类型清单（自检）
- 批零主表：批发主表、零售主表
- 住餐主表：住宿主表、餐饮主表
- 批零快照（月度）：批零类月度表
- 住餐快照（月度）：住餐类月度表
- 吃穿用、小微、吃穿用（剔除）
- 汇总/社零额模板：`社零额（定）`、`汇总表（定）`

