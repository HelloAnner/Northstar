# 预估 → 定稿 的映射与计算逻辑

> 目标：输入 `12月月报（预估）.xlsx`，输出 `12月月报（定）.xlsx`，且 sheet/格式/公式位置完全一致。

## 0. 总体策略（强约束）
- **必须以“定稿模板”作为输出模板**：读取 `12月月报（定）.xlsx` 作为模板，仅填充数据区域；保留合并单元格、列宽、字体、公式。
- **行顺序必须保持模板一致**：企业顺序不可随意排序。
- **单位换算规则必须统一**：模板中多为“千元”口径，汇总表中为“万元”。
- **输入兼容性**：输入文件可能包含额外月份或历史快照 sheet（如“2026年1月…”），禁止写死 sheet 名称。应基于“列结构特征”做类型识别；无法识别的 sheet 原样保留但不参与计算。
- **容错识别细则**：详见 `prd/06_输入容错与Sheet识别规则.md`。

---

## 1. 批发 / 零售 → 批零总表 / 批发 / 零售

### 1.1 字段映射（批发/零售主表 → 批发/零售输出）
以“批发”表为例，零售同理（字段名一致）：

| 输出字段 | 来源（预估） | 计算/说明 |
|---|---|---|
| 商品销售额;本年-本月 | 2025年12月销售额 | 用户可调整字段 |
| 商品销售额;上年-本月 | 2024年;12月;商品销售额;千元 | 固定历史字段 |
| (衍生指标)销售额当月增速 | (本年-本月 / 上年-本月 - 1) * 100 | 保留 2 位小数 |
| 商品销售额;本年-1—本月 | 2025年1-12月销售额 | 1-12累计 |
| 商品销售额;上年-1—本月 | 2024年;1-12月;商品销售额;千元 | 1-12累计 |
| (衍生指标)销售额累计增速 | (本年累计 / 上年累计 - 1) * 100 | 保留 2 位小数 |
| 零售额;本年-本月 | 2025年12月零售额 | 用户可调整字段 |
| 零售额;上年-本月 | 2024年;12月;商品零售额;千元 | 固定历史字段 |
| (衍生指标)零售额当月增速 | (本年-本月 / 上年-本月 - 1) * 100 | 保留 2 位小数 |
| 零售额;本年-1—本月 | 2025年1-12月零售额 | 1-12累计 |
| 零售额;上年-1—本月 | 2024年;1-12月;商品零售额;千元 | 1-12累计 |
| (衍生指标)零售额累计增速 | (本年累计 / 上年累计 - 1) * 100 | 保留 2 位小数 |
| 第一次上报的IP / 填报IP | 置空 | 按模板保留 |

> **注意**：输入表里 2025年12月销售额/零售额可能为空，系统提供“智能调整或手工调整”填值。

### 1.2 批零总表生成
- 批零总表 = 批发数据行 + 零售数据行（只包含企业行，不含汇总行）。
- 先按行业代码过滤生成“批发/零售”两个 sheet，再合并写入“批零总表”。

### 1.3 批发/零售汇总行（模板内的空行业行）
- 批发 sheet 的末尾存在 11 行汇总区；零售 sheet 末尾存在 2 行汇总区。
- 汇总区包含：
  - 批发行业合计（本年/上年当月与累计）。
  - 批发行业当月/累计增速。
  - 全行业合计（用于“汇总表（定）”的当月/累计零售额与增速）。
- 必须按模板位置写入（不能改变行数）。

> **关键映射示例**（模板中的关键值）
- 批发!J29 = 全行业零售额本年-本月（千元） → 汇总表（定）G4 = 批发!J29 / 10
- 批发!K29 = 全行业零售额上年-本月（千元） → 汇总表（定）H4 = 批发!K29 / 10
- 批发!M29 = 全行业零售额本年累计（千元） → 汇总表（定）I4 = 批发!M29 / 10
- 批发!N29 = 全行业零售额上年累计（千元） → 汇总表（定）J4 = 批发!N29 / 10
- 批发!L30 = 全行业零售额当月增速（%） → 汇总表（定）S4
- 批发!O30 = 全行业零售额累计增速（%） → 汇总表（定）T4

---

## 2. 住宿 / 餐饮 → 住餐总表 / 住宿 / 餐饮

### 2.1 字段映射（住宿/餐饮主表 → 住宿/餐饮输出）
以“住宿”表为例，餐饮同理：

| 输出字段 | 来源（预估） | 计算/说明 |
|---|---|---|
| 营业额;本年-本月 | 2025年12月营业额 | 可调整字段 |
| 营业额;上年-本月 | 2024年12月;营业额总计;千元 | 固定历史字段 |
| (衍生指标)营业额当月增速 | (本年 / 上年 - 1) * 100 | 保留 2 位小数 |
| 营业额;本年-1—本月 | 2025年1-12月营业额 | 累计 |
| 营业额;上年-1—本月 | 2024年1-12月;营业额总计;千元 | 累计 |
| (衍生指标)营业额累计增速 | (本年累计 / 上年累计 - 1) * 100 | 保留 2 位小数 |
| 客房收入;本年-本月 | 2025年12月客房收入 | 可调整字段 |
| 客房收入;上年-本月 | 2024年12月;客房收入;千元 | 固定历史字段 |
| 客房收入;本年-1—本月 | 2025年1-12月客房收入 | 累计 |
| 客房收入;上年-1—本月 | 2024年1-12月;客房收入;千元 | 累计 |
| 餐费收入;本年-本月 | 2025年12月餐费收入 | 可调整字段 |
| 餐费收入;上年-本月 | 2024年12月;餐费收入;千元 | 固定历史字段 |
| 餐费收入;本年-1—本月 | 2025年1-12月餐费收入 | 累计 |
| 餐费收入;上年-1—本月 | 2024年1-12月;餐费收入;千元 | 累计 |
| 商品销售额;本年-本月 | 2025年12月销售额 | 可调整字段 |
| 商品销售额;上年-本月 | 2024年12月;商品销售额;千元 | 固定历史字段 |
| 商品销售额;本年-1—本月 | 2025年1-12月销售额 | 累计 |
| 商品销售额;上年-1—本月 | 2024年1-12月;商品销售额;千元 | 累计 |

> 模板中有 Unnamed:21-24 列：保持模板原样写入，样例中通常为“餐费累计”的重复或 0。

### 2.2 住餐总表生成
- 住餐总表 = 住宿数据行 + 餐饮数据行（只包含企业行，不含汇总行）。

### 2.3 住宿/餐饮汇总行
- 每个 sheet 末尾 2 行：
  - 行1：行业合计（本年/上年当月、累计）
  - 行2：行业增速（当月/累计）
- 汇总表中的行业增速取值来源于此处：
  - 住宿业当月增速 → 汇总表（定）O4
  - 住宿业累计增速 → 汇总表（定）P4
  - 餐饮业当月增速 → 汇总表（定）Q4
  - 餐饮业累计增速 → 汇总表（定）R4

---

## 3. 吃穿用 / 小微 / 吃穿用（剔除）

### 3.1 吃穿用 sheet 生成逻辑
来源：批零总表 + 分类规则

- 吃穿用判定（优先级）：
  1) 若输入“零售”sheet 含“吃穿用”标记字段 → 直接使用
  2) 若无标记 → 使用行业代码规则（如 5211/5212/5213/5221/5222/5223/5241/5242/5243/5122/5123 等）

- 关键字段：
  - 当月吃穿用零售额 = (吃穿用? 零售额;本年-本月 : 0)
  - 上年同月吃穿用零售额 = (吃穿用? 零售额;上年-本月 : 0)
  - 吃穿用零售额当月增速 = (当月 / 上年 - 1) * 100（若上年为0且当月为0 → -100）

- 小微计算字段（为后续“小微”汇总准备）：
  - 计算用小微当月零售额 = (小微? 零售额;本年-本月 : 0)
  - 计算用小微上年同月零售额 = (小微? 零售额;上年-本月 : 0)

- 其他字段：网络销售额、开业时间年/月在输入中缺失时保持空值。

### 3.2 小微 sheet 生成逻辑
- 过滤条件：单位规模 = 3 或 4
- 计算字段：
  - 小微当月零售额增速 = (当月 / 上年 - 1) * 100（若上年为0且当月为0 → -100）

### 3.3 吃穿用（剔除） sheet 生成逻辑
- 吃穿用剔除规则来自业务规范（大企业、汽车类、特定行业排除等）
- 输出字段：仅保留被剔除企业的当月/上年同月吃穿用零售额

---

## 4. 社零额（定）模板公式（必须保留）

### 4.1 关键输入单元（全部为手工输入）
- J2：当前月份（样例为 12）
- B4/C4/D4：本月小微/吃穿用/抽样单位增速
- B6/C6/D6：上月小微/吃穿用/抽样单位增速
- B12/C12/D12：权重
- E18/E19/E20/E21/E22/E23：历史累计社零额
- I3：全省（市）限下零售额增速变动量

### 4.2 模板内公式（节选）
- K3 = E18 - E21
- K7 = K3 - K4
- K9 = (K7 - K8) / K8 * 100
- K15 = K14 * (1 + K11/100)
- K17 = K15 + K16
- K19 = (K17 - K18) / K18 * 100
- K23 = (K21 - K22) / K22 * 100

> 说明：模板内公式要保持原样，程序只写入依赖输入值。

---

## 5. 汇总表（定）模板公式与取值

### 5.1 公式
- D4 = C4/B4*100
- F4 = E4/C4*100
- D10 = IF(D4<>100, ...)
- A11 = CONCAT(摘要文字)

### 5.2 核心取值（行4）
- 限上零售额当月/上年/累计/累计上年：来自“批发”汇总区（总计行）
- 批发/零售/住宿/餐饮增速：分别来自四行业 sheet 的“行业增速行”
- 吃穿用增速、小微增速：来自“吃穿用/小微”汇总结果
- 单位数/已上报数/负增长企业数：需要 UI 手工输入
