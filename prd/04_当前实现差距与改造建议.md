# 当前实现差距与改造建议

> 目的：对比现有实现与目标输出（12月月报定稿模板），明确差距与修补路线。

## 1. 数据解析差距（输入侧）

### 1.1 解析模型仅支持“单 sheet + 映射”
- 现状：`internal/service/excel/parser.go` 只解析单个 sheet，依赖 UI 手工映射列名。
- 目标：输入文件包含 15 个 sheet，且字段名称固定，不是“企业名称/行业代码”等通用列名。
- 差距：
  - 无法自动识别“批发/零售/住宿/餐饮”主工作表
  - 无法解析多 sheet 并组装成统一企业视图
  - 映射字段名称完全不匹配（例如：`企业名称` vs `单位详细名称`，`行业代码` vs `201-1-行业代码`）
  - 输入文件可能新增月份或历史 sheet，现有逻辑无法兼容

**改造建议**
1) 固定模板解析：按 sheet 名称直接读取，不再依赖 UI 字段映射。
2) 识别“业务角色表”与“快照表”（避免写死名称，优先按字段结构识别）：
   - 批发/零售/住宿/餐饮 → 主工作表（可编辑）
   - 2024年12月批零 / 2025年11月批零 / 住餐等 → 历史快照
3) 统一行主键：优先用“统一社会信用代码 + 行业代码 + 行号”来稳定匹配。
4) 引入容错识别规范（字段集合+相似度阈值+人工确认）：见 `prd/06_输入容错与Sheet识别规则.md`。

### 1.2 模型字段不足
- 现状：`model.Company` 只有“零售额/销售额”四对字段。
- 目标：必须支持“营业额、客房收入、餐费收入、商品销售额”等多维字段，并要输出多 sheet。
- 差距：住宿/餐饮的数据结构无法承载。

**改造建议**
- 扩展模型：
  - 批零：销售额/零售额（月/累计/上年）
  - 住餐：营业额/客房收入/餐费收入/商品销售额（月/累计/上年）
- 将“批零总表/住餐总表”作为**输出视图**而非内部唯一数据结构。

---

## 2. 计算逻辑差距（指标/规则）

### 2.1 现有计算仅 16 指标
- 现状：`calculator.Engine` 仅计算 16 项指标
- 目标：需要驱动“汇总表（定）”与“社零额（定）”，并支撑四大行业、吃穿用、小微、限下估算等组合指标。

**改造建议**
- 在 16 项指标基础上，补齐：
  - 行业合计与增速（写入模板汇总区）
  - 吃穿用、小微的“列表 + 汇总增速”
  - 限下估算与社零额（定）公式输入项

### 2.2 业务规则缺失
- 现状：仅限制“零售额 ≤ 销售额”、简单增速警告
- 目标：需要满足 PDF 第 11 页的多规则约束（零销比、增速上限、客房/餐费关系、数值不雷同等）

**改造建议**
- 引入规则引擎：对每条规则生成约束结果（error/warn）
- 在调整算法中强制约束：
  - 软约束：提示 + 允许用户继续
  - 硬约束：阻止提交

---

## 3. 调整算法差距

### 3.1 现有 Optimizer 只调整零售额
- 现状：只支持“限上累计增速”目标，且单字段贪心分配
- 目标：需要多字段联动（销售额/零售额/客房收入/餐费收入），满足多规则约束

**改造建议**
- 以“目标增速 + 规则约束 + 最小调整量”为优化目标
- 可调字段：
  - 批零：12月销售额、12月零售额
  - 住餐：12月营业额、客房收入、餐费收入、商品销售额
- 引入分行业权重 + 小微/吃穿用优先级策略

---

## 4. 导出差距（输出侧）

### 4.1 当前导出不符合模板
- 现状：`excel/exporter.go` 只输出“企业数据 + 指标汇总”
- 目标：必须输出 11 个 sheet，包含固定格式、合并单元格与公式

**改造建议**
1) 以 `12月月报（定）.xlsx` 作为输出模板
2) 只填充数据区域，不生成新的 sheet
3) 保留模板公式（社零额、汇总表的公式不可改写）
4) 对模板内固定汇总行写值（如批发汇总区 J29 等）

---

## 5. UI 差距（页面与交互）

### 5.1 导入流程不匹配
- 现状：Import Wizard 需要手工映射字段、仅能选一个 sheet
- 目标：固定模板解析、多 sheet 自动读取

**改造建议**
- 导入页面显示：
  - 已识别的 15 个 sheet + 状态
  - 关键字段校验结果（缺失、异常、重复）
- 去掉“字段映射”步骤，改为“模板校验 + 预览”

### 5.2 主工作台不匹配
- 现状：Dashboard 只展示 16 指标 + 企业表格
- 目标：需要与“定稿 Excel”输出结构一致的视图

**改造建议**
- 在 UI 增加多 Tab：批零总表 / 住餐总表 / 吃穿用 / 小微 / 汇总表
- 增加“社零额（定）”输入区（权重、增速、上年累计等，**全部手工输入**）
- 每次编辑即时联动全部汇总指标

---

## 6. 其他关键差距
- `Generator` 默认 currentMonth=6，与 12 月口径不一致
- `isEatWearUse` 规则简化，需要替换为完整规则
- 模板中存在重复列（Unnamed），需要保留位置和数值

---

## 7. 修补优先级（从最快到最关键）
1) **模板输出链路**：能够用预估数据生成 11 个 sheet 的定稿结构
2) **多 sheet 解析**：自动读取与校验
3) **基础联动计算**：补齐吃穿用/小微/行业增速
4) **规则引擎 + 优化算法**：满足复杂业务约束
5) **UI 对齐**：支持模板化展示与编辑
